jpsVersion: 1.3
jpsType: install
application:
  id: shopozor-ci
  name: Shopozor Continuous Integration
  version: 0.0
  baseUrl: https://raw.githubusercontent.com/softozor/shopozor-ci/master

  globals:
    JENKINS_PLUGINS_FILENAME: listOfJenkinsPlugins.txt
    CREDENTIAL_FILENAME: credential.xml
    GITHUB_CREDENTIAL_FILENAME: github-credentials.xml
    BITBUCKET_CREDENTIAL_FILENAME: bitbucket-credentials.xml
    HIDORA_CREDENTIAL_FILENAME: hidora-credentials.xml
    CREDENTIAL_SCRIPT: CreateCredential.sh
    JOB_CREATION_SCRIPT: CreateJob.sh
    GITHUB_CREDENTIALS_ID: github-credentials
    BITBUCKET_CREDENTIALS_ID: bitbucket-credentials
    HIDORA_CREDENTIALS_ID: hidora-credentials

  settings:
    fields:
      - type: spacer
        caption: Github credentials
      - name: githubUsername
        caption: User
        type: string
        required: true
      - name: githubPassword
        caption: Password
        type: string
        inputType: password
        required: true
      - type: spacer
        caption: Bitbucket credentials
      - name: bitbucketUsername
        caption: User
        type: string
        required: true
      - name: bitbucketPassword
        caption: Password
        type: string
        inputType: password
        required: true
      - type: spacer
        caption: Hidora credentials
      - name: hidoraUsername
        caption: User
        type: string
        required: true
      - name: hidoraPassword
        caption: Password
        type: string
        inputType: password
        required: true

  env:
    topology:
      nodes:
        - image: jenkins/jenkins:lts
          count: 1
          cloudlets: 16
          nodeGroup: cp

  onInstall:
    - installDocker
    - installPlugins
    - setupCredentials
    - setupJobs

  actions:
    installDocker:
      cmd [cp]:
        - curl -fsSL ${baseUrl}/scripts/InstallDocker.sh | /bin/bash
    installPlugins:
      - cmd [cp]:
          - cd /tmp
          - wget ${baseUrl}/config/${globals.JENKINS_PLUGINS_FILENAME}
          - curl -fsSL ${baseUrl}/scripts/InstallPlugins.sh | /bin/bash -s ${globals.JENKINS_PLUGINS_FILENAME}
      - upload:
          - nodeGroup: cp
            sourcePath: ${baseUrl}/config/org.jenkinsci.plugins.ghprb.GhprbTrigger.xml
            destPath: /var/jenkins_home/org.jenkinsci.plugins.ghprb.GhprbTrigger.xml
      - replaceInFile:
          nodeType: docker
          path: /var/jenkins_home/org.jenkinsci.plugins.ghprb.GhprbTrigger.xml
          replacements:
            - pattern: GITHUB_CREDENTIALS
              replacement: ${globals.GITHUB_CREDENTIALS_ID}
      - restart
    setupCredentials:
      - cmd [cp]:
          - cd /tmp
          - wget ${baseUrl}/config/${globals.CREDENTIAL_FILENAME}
          - cp ${globals.CREDENTIAL_FILENAME} ${globals.GITHUB_CREDENTIAL_FILENAME}
          - cp ${globals.CREDENTIAL_FILENAME} ${globals.BITBUCKET_CREDENTIAL_FILENAME}
          - cp ${globals.CREDENTIAL_FILENAME} ${globals.HIDORA_CREDENTIAL_FILENAME}
      - replaceInFile:
          nodeType: docker
          path: /tmp/${globals.GITHUB_CREDENTIAL_FILENAME}
          replacements:
            - pattern: GLOBAL_OR_SYSTEM
              replacement: GLOBAL
            - pattern: CREDENTIAL_ID
              replacement: ${globals.GITHUB_CREDENTIALS_ID}
            - pattern: USERNAME
              replacement: ${settings.githubUsername}
            - pattern: PASSWORD
              replacement: ${settings.githubPassword}
            - pattern: DESCRIPTION
              replacement: Github credentials
      - replaceInFile:
          nodeType: docker
          path: /tmp/${globals.BITBUCKET_CREDENTIAL_FILENAME}
          replacements:
            - pattern: GLOBAL_OR_SYSTEM
              replacement: GLOBAL
            - pattern: CREDENTIAL_ID
              replacement: ${globals.BITBUCKET_CREDENTIALS_ID}
            - pattern: USERNAME
              replacement: ${settings.bitbucketUsername}
            - pattern: PASSWORD
              replacement: ${settings.bitbucketPassword}
            - pattern: DESCRIPTION
              replacement: Bitbucket credentials
      - replaceInFile:
          nodeType: docker
          path: /tmp/${globals.HIDORA_CREDENTIAL_FILENAME}
          replacements:
            - pattern: GLOBAL_OR_SYSTEM
              replacement: GLOBAL
            - pattern: CREDENTIAL_ID
              replacement: ${globals.HIDORA_CREDENTIALS_ID}
            - pattern: USERNAME
              replacement: ${settings.hidoraUsername}
            - pattern: PASSWORD
              replacement: ${settings.hidoraPassword}
            - pattern: DESCRIPTION
              replacement: Hidora credentials 
      - cmd [cp]:
          - wget ${baseUrl}/scripts/${globals.CREDENTIAL_SCRIPT} -O /tmp/${globals.CREDENTIAL_SCRIPT}
          - chmod u+x /tmp/${globals.CREDENTIAL_SCRIPT}
          - /tmp/${globals.CREDENTIAL_SCRIPT} /tmp/${globals.GITHUB_CREDENTIAL_FILENAME}
          - /tmp/${globals.CREDENTIAL_SCRIPT} /tmp/${globals.BITBUCKET_CREDENTIAL_FILENAME}
          - /tmp/${globals.CREDENTIAL_SCRIPT} /tmp/${globals.HIDORA_CREDENTIAL_FILENAME}
      - restart
    setupJobs:
      - upload:
        - nodeGroup: cp
          sourcePath: ${baseUrl}/config/test-job.xml
          destPath: /tmp/test-job.xml
      - replaceInFile:
          nodeType: docker
          path: /tmp/test-job.xml
          replacements:
            - pattern: GITHUB_CREDENTIAL_ID
              replacement: ${globals.GITHUB_CREDENTIALS_ID}
      - cmd [cp]:
        - cd /tmp
        - wget ${baseUrl}/scripts/${globals.JOB_CREATION_SCRIPT}
        - chmod u+x ./${globals.JOB_CREATION_SCRIPT}
        - ./${globals.JOB_CREATION_SCRIPT} "test-job"
      - restart
    restart:  
      - restartContainers:
        - nodeGroup: cp
success: |
  **Your environment Jenkins has been installed successfully.**
